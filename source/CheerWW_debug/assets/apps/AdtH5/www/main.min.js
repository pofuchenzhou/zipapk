var AssetAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getAsset=function(e,t,n){function s(s){t.call(n,s,e)}if(RES.hasRes(e)){var i=RES.getRes(e);i?s(i):RES.getResAsync(e,s,this)}else RES.getResByUrl(e,s,this,RES.ResourceItem.TYPE_IMAGE)},e}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var ChatCell=function(e){function t(t,n,s){void 0===n&&(n=!0),void 0===s&&(s=!1),e.call(this),this.hOffset=60,this.wOffset=54,this.isSelf=!1,this.isPrivate=!1,this.isSelf=n,this.isPrivate=s,n?this.skinName="ChatCellForSelfSkin":this.skinName="ChatCellForOtherSkin",this.percentWidth=100,this.data=t,this.visible=!1}__extends(t,e);var n=(__define,t),s=n.prototype;return s.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.headImg.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTabHeadHandler,this),egret.callLater(function(){t.headImg.source=t.data.faceIndex+"_png",t.textLabel.text=t.data.message,t.nickLabel.text=t.data.nickname,t.textLabel.width>.6*t.width&&(t.textLabel.width=.6*t.width),t.backImg.width=t.textLabel.width+t.wOffset,t.height=t.textLabel.height+t.hOffset,egret.callLater(function(){t.visible=!0},t)},this)},s.replace_em=function(e){return e=e.replace(/\</g,"&lt;"),e=e.replace(/\>/g,"&gt;"),e=e.replace(/\n/g,"<br/>"),e=e.replace(/\[em_([0-9]*)\]/g,'<img src="$1_gif" border="0" />')},s.onTabHeadHandler=function(e){this.isSelf||this.isPrivate||this.dispatchEventWith(t.TAB_HEAD_EVENT,!0,{stageX:e.stageX,stageY:e.stageY})},t.TAB_HEAD_EVENT="TAB_HEAD_EVENT",t}(eui.Component);egret.registerClass(ChatCell,"ChatCell");var ChatScene=function(e){function t(){e.call(this),this.skinName="ChatSkin",this.percentHeight=this.percentWidth=100}__extends(t,e);var n=(__define,t),s=n.prototype;return s.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.showWorld(),this.initGroup.visible=!0,this.privateTab.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this),this.worldTab.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this),this.scrollGroup.addEventListener(ChatCell.TAB_HEAD_EVENT,this.cellHeadTabHandler,this),this.inputText.addEventListener(egret.Event.CHANGE,this.onInputChangeHandler,this),this.soundBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPlugHandler,this),this.faceBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPlugHandler,this),this.addBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onPlugHandler,this),this.sendBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onSendHandler,this),this.privateList.addEventListener(egret.Event.CHANGE,this.changeListItemHandler,this),this.toggleListBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onToggleListHandler,this),Server.getInstance().addEventListener(MessageType.P2P_MSG,this.onMessageHandler,this),Server.getInstance().addEventListener(MessageType.P2P_STATE,this.onMessageHandler,this),Server.getInstance().addEventListener(MessageType.WORLD_MSG,this.onMessageHandler,this),Server.getInstance().addEventListener(MessageType.WORLD_STATE,this.onMessageHandler,this),document.addEventListener("keydown",function(e){13==e.keyCode&&t.onSendHandler(null)});for(var n=0;200>n;n++)DataManager.userList.addItem({nickname:"xxxx"+n,face:1});this.privateList.dataProvider=DataManager.userList,Server.getInstance().addEventListener(Server.CONNECT_SUCCESS,this.onConnectHandler,this),Server.getInstance().addEventListener(Server.CONNECT_CLOSE,this.onConnectHandler,this),Server.getInstance().addEventListener(Server.CONNECT_FAIL,this.onConnectHandler,this),this.createDiv()},s.createDiv=function(){console.log("创建聊天面板div");var e=document.createElement("div");e.setAttribute("class","tabCon focus"),e.setAttribute("title","world");var t=document.createElement("div");t.setAttribute("class","msgShowPanel"),e.appendChild(t);var n=document.createElement("ol");t.appendChild(n);for(var s=0;20>s;s++)this.addMsgItemOnScreen(e,n,"无名氏",s);var i=document.getElementsByTagName("body")[0];i.appendChild(e);var r=$(t),a=30;r.scroll(function(){console.log("一直在滚动");var e=$(n).children();if(console.log("首元素："+$(e[0]).position().top),$(e[0]).position().top<-237){var t=$(e[0]).clone(!0);$(e[0]).remove(),$(n).append(t),$("div").scrollTop($("div").scrollTop()+20)}a++})},s.addMsgItemOnScreen=function(e,t,n,s){null!=s&&""!=s&&t.appendChild(this.createMsg(s,n))},s.createMsg=function(e,t){var n=document.createElement("div");n.setAttribute("class","messageDiv");var s=document.createElement("img");s.src="resource/assets/chat/head.png",n.appendChild(s);var i=document.createElement("span");i.setAttribute("class","name"),i.innerHTML=t,n.appendChild(i);var r=document.createElement("span");r.setAttribute("class","arrow"),n.appendChild(r);var a=document.createElement("p");a.setAttribute("class","con"),a.innerText=e,n.appendChild(a);var o=document.createElement("div");return n.appendChild(o),n},s.onConnectHandler=function(e){switch(this.initGroup.visible=!0,e.type){case Server.CONNECT_SUCCESS:this.stateLabel.text="服务器连接成功...",this.initGroup.visible=!1;break;case Server.CONNECT_CLOSE:this.stateLabel.text="服务器连接断开...";break;case Server.CONNECT_FAIL:this.stateLabel.text="服务器连接失败..."}},s.cellHeadTabHandler=function(e){this.popMenu||(this.popMenu=new PopMenu,this.popMenu.addEventListener(PopMenu.TO_PRIVATE_CHANNEL,this.popMenuToPrivateHandler,this),this.addChild(this.popMenu)),this.popMenu.show(e.data.stageX,e.data.stageY,e.target)},s.onSendHandler=function(e){if(""!=this.inputText.text){var t,n={groupId:"0",fromuid:DataManager.uid,message:this.inputText.text,nickname:DataManager.nickname,faceIndex:DataManager.headIndex};if(this.worldTab.selected)Server.getInstance().sendWorld(n),t=new ChatCell(n,!0,!1),DataManager.worldInfos.push(t);else{if(!this.privateList.selectedItem)return void alert("请先选择您要私聊的对象！");n.touid=this.privateList.selectedItem.fromuid,t=new ChatCell(n,!0,!0),DataManager.privateInfos[n.touid].push(t),Server.getInstance().sendP2P(n)}this.inputText.text="",this.scrollGroup.addChild(t),this.updateScrollPosition(),this.onInputChangeHandler(null)}},s.onPlugHandler=function(e){switch(e.currentTarget){case this.faceBtn:break;default:alert("该功能尚未开启，敬请期待!")}},s.onInputChangeHandler=function(e){""!=this.inputText.text},s.onMessageHandler=function(e){var t=e.data;switch(e.type){case MessageType.P2P_MSG:DataManager.addUserListMember({nickname:t.message.nickname,faceIndex:t.message.faceIndex,face:t.message.faceIndex+"_png",fromuid:t.message.fromuid});var n=new ChatCell(t.message,!1,!0);DataManager.privateInfos[t.message.fromuid].push(n),this.privateTab.selected&&this.privateList.selectedItem.fromuid==t.message.fromuid&&this.scrollGroup.addChild(n);break;case MessageType.P2P_STATE:console.log(t);break;case MessageType.WORLD_MSG:var n=new ChatCell(t.message,!1,!1);DataManager.worldInfos.push(n),this.worldTab.selected&&this.scrollGroup.addChild(n);break;case MessageType.WORLD_STATE:console.log(t)}this.updateScrollPosition()},s.updateScrollPosition=function(){var e=this;egret.callLater(function(){var t=e.scrollGroup.contentHeight-e.msgScroller.height;e.msgScroller.viewport.scrollV=0>t?0:t},this,100)},s.popMenuToPrivateHandler=function(e){var t=this,n=DataManager.getUidIndex(e.data);n>=0&&egret.callLater(function(){t.privateList.selectedIndex=n,t.showPrivate()},this)},s.onTabHandler=function(e){e.currentTarget==this.privateTab?this.showPrivate():this.showWorld()},s.showWorld=function(){this.worldTab.selected=!0,this.worldTab.touchChildren=this.worldTab.touchEnabled=!1,this.privateTab.selected=!1,this.privateTab.touchChildren=this.privateTab.touchEnabled=!0,this.privateListGroup.visible=!1,this.privateListGroup.width=0,this.toggleListBtn.scaleX=0,this.scrollGroup.removeChildren();for(var e=0;e<DataManager.worldInfos.length;e++)this.scrollGroup.addChild(DataManager.worldInfos[e]);this.updateScrollPosition()},s.showPrivate=function(){this.privateTab.selected=!0,this.privateTab.touchChildren=this.privateTab.touchEnabled=!1,this.worldTab.selected=!1,this.worldTab.touchChildren=this.worldTab.touchEnabled=!0,this.openList(),this.changeListItemHandler()},s.openList=function(){this.privateListGroup.visible=!0,this.privateListGroup.width=324,this.toggleListBtn.scaleX=-1},s.closeList=function(){this.privateListGroup.visible=!1,this.privateListGroup.width=0,this.toggleListBtn.scaleX=1},s.onToggleListHandler=function(e){this.toggleListBtn.scaleX>=0?this.openList():this.closeList()},s.changeListItemHandler=function(e){this.scrollGroup.removeChildren(),this.showPrivateUserChat(),this.updateScrollPosition()},s.showPrivateUserChat=function(){this.privateList.selectedIndex<0&&DataManager.userList.length>0&&(this.privateList.selectedIndex=0);this.privateList.selectedItem},t}(eui.Component);egret.registerClass(ChatScene,"ChatScene");var PopMenu=function(e){function t(){e.call(this),this.skinName="PopMenuSkin",this.privateGroup.anchorOffsetX=75,this.privateGroup.anchorOffsetY=86,this.percentHeight=this.percentWidth=100,this.hide()}__extends(t,e);var n=(__define,t),s=n.prototype;return s.onTabHandler=function(e){e.currentTarget==this.privateGroup&&(DataManager.addUserListMember({nickname:this.curTarget.data.nickname,faceIndex:this.curTarget.data.faceIndex,face:this.curTarget.data.faceIndex+"_png",fromuid:this.curTarget.data.fromuid}),this.dispatchEventWith(t.TO_PRIVATE_CHANNEL,!1,this.curTarget.data.fromuid)),this.hide()},s.hide=function(){this.visible=!1,this.privateGroup.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this),this.popMenuBack.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this)},s.show=function(e,t,n){this.curTarget=n,this.privateGroup.x=75>e?75:e,this.privateGroup.y=86>t?86:t,this.visible=!0,this.privateGroup.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this),this.popMenuBack.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTabHandler,this)},t.TO_PRIVATE_CHANNEL="TO_PRIVATE_CHANNEL",t}(eui.Component);egret.registerClass(PopMenu,"PopMenu");var SystemUtils=function(){function e(){}var t=(__define,e);t.prototype;return e.newGuid=function(){for(var e="",t=1;32>=t;t++){var n=Math.floor(16*Math.random()).toString(16);e+=n,(8==t||12==t||16==t||20==t)&&(e+="-")}return e},e.NewGuid=function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},e}();egret.registerClass(SystemUtils,"SystemUtils");var DataManager=function(){function e(){}var t=(__define,e);t.prototype;return e.addUserListMember=function(t){for(var n,s=0;s<e.userList.length;s++)if(n=e.userList.getItemAt(s),n.fromuid==t.fromuid)return;e.privateInfos[t.fromuid]=[],e.userList.addItem(t)},e.getUidIndex=function(t){for(var n,s=0;s<e.userList.length;s++)if(n=e.userList.getItemAt(s),n.fromuid==t)return s;return-1},e.loginSuccess=function(t,n,s){e.uid=t.id,e.nickname=t.nickName,SceneManager.getInstance().show(new ChatScene),egret.localStorage.setItem(e.userNameKey,n),egret.localStorage.setItem(e.userPwdKey,s)},e.uid=SystemUtils.NewGuid(),e.headIndex=1,e.nickname="test",e.worldInfos=[],e.privateInfos={},e.userNameKey="chat_userNameKey",e.userPwdKey="chat_userPwdKey",e.localPwdKey="chat_localPwdKey",e.autoLoginKey="chat_autoLoginKey",e.loginBaseURL="http://192.168.113.182:8080/gamecloud-usercenter",e.loginPath="/login/user",e.nickRegisterPath="/register/name",e.getCodePath="/login/captchaimg",e.guestPath="/login/anonymous",e.chatURL="ws://192.168.113.182:8089/websocket",e.sid="",e.userList=new eui.ArrayCollection,e}();egret.registerClass(DataManager,"DataManager");var EventsType=function(){function e(){}var t=(__define,e);t.prototype;return e.IntoChatScene="IntoChatScene",e.IntoRegisterScene="IntoRegisterScene",e.IntoLoginScene="IntoLoginScene",e}();egret.registerClass(EventsType,"EventsType");var InitializeScene=function(e){function t(){e.call(this),this.curIndex=1,this.skinName="InitializeSkin",this.percentHeight=this.percentWidth=100}__extends(t,e);var n=(__define,t),s=n.prototype;return s.childrenCreated=function(){e.prototype.childrenCreated.call(this),Server.getInstance().addEventListener(Server.CONNECT_SUCCESS,this.onConnectHandler,this),Server.getInstance().addEventListener(Server.CONNECT_CLOSE,this.onConnectHandler,this),Server.getInstance().addEventListener(Server.CONNECT_FAIL,this.onConnectHandler,this)},s.onConnectHandler=function(e){switch(this.initGroup.visible=!0,e.type){case Server.CONNECT_SUCCESS:this.stateLabel.text="服务器连接成功...",this.initGroup.visible=!1,this.inGameBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onInChatHandler,this),this.headGroup.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onHeadGroupHandler,this);break;case Server.CONNECT_CLOSE:this.stateLabel.text="服务器连接断开...";break;case Server.CONNECT_FAIL:this.stateLabel.text="服务器连接失败..."}},s.onHeadGroupHandler=function(e){var t;e.target.constructor==eui.Image&&(t=e.target,this.selectRect.x=t.x,this.selectRect.y=t.y),this.curIndex=t.source.toString().split("_")[0]},s.onInChatHandler=function(e){return""==this.nameInput.text?void alert("请输入您的昵称"):(DataManager.nickname=this.nameInput.text,DataManager.headIndex=this.curIndex,void this.dispatchEventWith(t.IntoChatScene))},s.clear=function(){this.inGameBtn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onInChatHandler,this),this.headGroup.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onHeadGroupHandler,this),Server.getInstance().removeEventListener(Server.CONNECT_SUCCESS,this.onConnectHandler,this),Server.getInstance().removeEventListener(Server.CONNECT_CLOSE,this.onConnectHandler,this),Server.getInstance().removeEventListener(Server.CONNECT_FAIL,this.onConnectHandler,this)},t.IntoChatScene="intoChatScene",t}(eui.Component);egret.registerClass(InitializeScene,"InitializeScene");var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var n=(__define,t),s=n.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.width=egret.MainContext.instance.stage.stageWidth,this.textField.height=egret.MainContext.instance.stage.stageHeight,this.textField.textAlign="center"},s.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var CodeImage=function(e){function t(){e.call(this),this.request=new egret.HttpRequest,this.request.responseType=egret.HttpResponseType.TEXT,this.request.open(DataManager.loginBaseURL+DataManager.getCodePath,egret.HttpMethod.GET),this.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.request.addEventListener(egret.Event.COMPLETE,this.onGetComplete,this),this.request.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onGetIOError,this)}__extends(t,e);var n=(__define,t),s=n.prototype;return s.getCodeImage=function(){this.request.send()},s.onGetComplete=function(e){var t=JSON.parse(this.request.response);DataManager.sid=t.sid,this.baseToBitmap("data:image/jpeg;base64,"+t.base64Str)},s.onGetIOError=function(e){console.log("get error : "+e)},s.baseToBitmap=function(e){var n=this,s=new Image;s.avaliable=!0;s.onload=function(){var e=new egret.Texture;e._setBitmapData(s),n.dispatchEventWith(t.CODE_IMAGE_COMPLETE,!1,e)},s.src=e},s.clear=function(){this.request.removeEventListener(egret.Event.COMPLETE,this.onGetComplete,this),this.request.removeEventListener(egret.IOErrorEvent.IO_ERROR,this.onGetIOError,this)},t.CODE_IMAGE_COMPLETE="CODE_IMAGE_COMPLETE",t}(egret.EventDispatcher);egret.registerClass(CodeImage,"CodeImage");var LoginScene=function(e){function t(){e.call(this),this.skinName="LoginSceneSkin",this.percentHeight=this.percentWidth=100}__extends(t,e);var n=(__define,t),s=n.prototype;return s.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.loginBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.registerBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.postRequest=new PostRequest,this.postRequest.addEventListener(PostRequest.POST_COMPLETE_EVENT,this.onPostCompleteHandler,this),this.autoLoginBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.nameInput.text=egret.localStorage.getItem(DataManager.userNameKey),this.pwdInput.text=egret.localStorage.getItem(DataManager.userPwdKey),this.pwdInput.displayAsPassword=!0;egret.localStorage.getItem(DataManager.localPwdKey)},s.onButtonHandler=function(e){if(e.currentTarget==this.loginBtn){if(""==this.nameInput.text)return void alert("请输入用户名！");if(""==this.pwdInput.text)return void alert("请输入密码！");this.postRequest.send(DataManager.loginPath+"?username="+this.nameInput.text+"&password="+this.pwdInput.text)}else e.currentTarget==this.registerBtn?SceneManager.getInstance().show(new RegisterScene):e.currentTarget==this.autoLoginBtn&&(this.pwdInput.text="",this.postRequest.send(DataManager.guestPath))},s.onPostCompleteHandler=function(e){e.data.flag?(egret.localStorage.setItem(DataManager.localPwdKey,"true"),this.postRequest.clear(),this.registerBtn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.loginBtn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.postRequest.removeEventListener(PostRequest.POST_COMPLETE_EVENT,this.onPostCompleteHandler,this),DataManager.loginSuccess(e.data.obj,this.nameInput.text,this.pwdInput.text)):alert(e.data.message)},t}(eui.Component);egret.registerClass(LoginScene,"LoginScene");var RegisterScene=function(e){function t(){e.call(this),this.skinName="RegisterSceneSkin",this.percentHeight=this.percentWidth=100,this.codeImage=new CodeImage,this.codeImage.addEventListener(CodeImage.CODE_IMAGE_COMPLETE,this.onCodeImageHandler,this),this.codeImage.getCodeImage(),this.postRequest=new PostRequest,this.postRequest.addEventListener(PostRequest.POST_COMPLETE_EVENT,this.onPostCompleteHandler,this)}__extends(t,e);var n=(__define,t),s=n.prototype;return s.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.codeTexture&&(this.codeImg.source=this.codeTexture),this.registerBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this)},s.onCodeImageHandler=function(e){this.codeImg?this.codeImg.source=e.data:this.codeTexture=e.data},s.onButtonHandler=function(e){return""==this.nameInput.text?void alert("请输入帐号！"):""==this.nicknameInput.text?void alert("请输入昵称！"):""==this.pwdInput.text?void alert("请输入密码！"):this.pwdInput.text!=this.rpwdInput.text?void alert("两次输入的密码不一致！"):""==this.codeInput.text?void alert("请输入验证码！"):void this.postRequest.send(DataManager.nickRegisterPath+"?name="+this.nameInput.text+"&code="+this.codeInput.text+"&password="+this.pwdInput.text+"&nickname="+this.nicknameInput.text+"&sid="+DataManager.sid)},s.onPostCompleteHandler=function(e){e.data.flag?(this.codeImage.clear(),this.postRequest.clear(),this.codeImage.removeEventListener(CodeImage.CODE_IMAGE_COMPLETE,this.onCodeImageHandler,this),this.registerBtn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonHandler,this),this.postRequest.removeEventListener(PostRequest.POST_COMPLETE_EVENT,this.onPostCompleteHandler,this),DataManager.loginSuccess(e.data.obj,this.nameInput.text,this.pwdInput.text)):alert(e.data.message)},t}(eui.Component);egret.registerClass(RegisterScene,"RegisterScene");var Main=function(e){function t(){e.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(t,e);var n=(__define,t),s=n.prototype;return s.createChildren=function(){e.prototype.createChildren.call(this),SceneManager.getInstance().initRoot(this);var t=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",t),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var t=new eui.Theme("resource/default.thm.json",this.stage);t.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},s.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},s.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},s.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.startCreateScene()},s.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},s.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load")},s.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},s.startCreateScene=function(){ProtoBuild.registerProtocol(RES.getRes("Message_proto")),ProtoBuild.registerProtocol(RES.getRes("CommandMessage_proto")),this.loginScene=new LoginScene,this.addChild(this.loginScene)},t}(eui.UILayer);egret.registerClass(Main,"Main");var MessageType=function(){function e(){}var t=(__define,e);t.prototype;return e.P2P_STATE="response_10000",e.P2P_MSG="response_10002",e.WORLD_STATE="response_12000",e.WORLD_MSG="response_12002",e}();egret.registerClass(MessageType,"MessageType");var SceneManager=function(){function e(){}var t=(__define,e),n=t.prototype;return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},n.initRoot=function(e){this.root=e},n.show=function(e){this.newScene&&this.root.removeChild(this.newScene),this.newScene=e,this.root.addChild(this.newScene)},e}();egret.registerClass(SceneManager,"SceneManager");var Server=function(e){function t(){if(t.instance)throw new Error("重复初始化！");e.call(this),this.webSocket=new egret.WebSocket,this.webSocket.type=egret.WebSocket.TYPE_BINARY,this.webSocket.addEventListener(egret.ProgressEvent.SOCKET_DATA,this.onReceiveMessage,this),this.webSocket.addEventListener(egret.Event.CLOSE,this.onCloseHandler,this),this.webSocket.addEventListener(egret.IOErrorEvent.IO_ERROR,this.ioErrorHandler,this),this.webSocket.addEventListener(egret.Event.CONNECT,this.onSocketOpen,this),this.webSocket.connectByUrl(DataManager.chatURL)}__extends(t,e);var n=(__define,t),s=n.prototype;return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},s.onCloseHandler=function(e){this.dispatchEventWith(t.CONNECT_CLOSE)},s.ioErrorHandler=function(e){this.dispatchEventWith(t.CONNECT_FAIL)},s.onSocketOpen=function(){this.registerUser(DataManager.uid),this.dispatchEventWith(t.CONNECT_SUCCESS)},s.registerUser=function(e){this.send(10100,{uid:e})},s.onReceiveMessage=function(e){this.buffer=new egret.ByteArray,this.webSocket.readBytes(this.buffer),console.log("消息长度："+this.buffer.length),this.decodeMsg(this.buffer)},s.decodeMsg=function(e){var t=new egret.ByteArray;this.readBytes(e,t,4);var n=ProtoBuild.decode("Commond",t.buffer),s=ProtoBuild.decode("response_"+n.commandId,n.message);this.dispatchEventWith("response_"+n.commandId,!1,s)},s.readBytes=function(e,t,n,s){if(void 0===n&&(n=0),void 0===s&&(s=0),0==s)s=e.bytesAvailable;else if(!e.validate(s))return null;t?t.validateBuffer(s):t=new egret.ByteArray(new ArrayBuffer(s));for(var i=n;s>i;i++)t.data.setUint8(i-n,e.data.getUint8(i))},s.send=function(e,t){var n=ProtoBuild.encode("request_"+e,t),s=ProtoBuild.encode("Commond",{commandId:e,message:n}),i=ProtoBuild.encode("RequestMessage",{requestType:2,gameId:"chatdemo2016",channelId:[3],message:s}),r=new egret.ByteArray(i),a=new egret.ByteArray;a.writeInt(r.length),a.writeBytes(r),console.log("发送数据长度："+a.length),this.webSocket.writeBytes(a)},s.sendChatMsg=function(e,t){this.send(e,{message:t})},s.sendP2P=function(e){this.sendChatMsg(1e4,e)},s.sendWorld=function(e){this.sendChatMsg(12e3,e)},t.CONNECT_SUCCESS="CONNECT_SUCCESS",t.CONNECT_FAIL="CONNECT_FAIL",t.CONNECT_CLOSE="CONNECT_CLOSE",t}(egret.EventDispatcher);egret.registerClass(Server,"Server");var ThemeAdapter=function(){function e(){}var t=(__define,e),n=t.prototype;return n.getTheme=function(e,t,n,s){function i(e){t.call(s,e)}function r(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),n.call(s))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,r,null),RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_TEXT)},e}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var PostRequest=function(e){function t(){e.call(this),this.request=new egret.HttpRequest,this.request.responseType=egret.HttpResponseType.TEXT,this.request.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.request.addEventListener(egret.Event.COMPLETE,this.onPostComplete,this),this.request.addEventListener(egret.IOErrorEvent.IO_ERROR,this.onPostIOError,this)}__extends(t,e);var n=(__define,t),s=n.prototype;return s.send=function(e){this.request.open(DataManager.loginBaseURL+e,egret.HttpMethod.POST),this.request.send()},s.onPostComplete=function(e){this.dispatchEventWith(t.POST_COMPLETE_EVENT,!1,JSON.parse(this.request.response))},s.onPostIOError=function(e){console.log("post error : "+e)},s.clear=function(){this.request.removeEventListener(egret.Event.COMPLETE,this.onPostComplete,this),this.request.removeEventListener(egret.IOErrorEvent.IO_ERROR,this.onPostIOError,this)},t.POST_COMPLETE_EVENT="POST_COMPLETE_EVENT",t}(egret.EventDispatcher);egret.registerClass(PostRequest,"PostRequest");var ProtoBuild=function(){function e(){}var t=(__define,e);t.prototype;return e.registerProtocol=function(t){var n=ProtoBuf.loadProto(t).build();for(var s in n){if(e.protoModels[s])throw new Error("消息"+s+"重复注册！！");e.protoModels[s]=n[s]}},e.getMessageModel=function(t){var n=e.protoModels[t];if(!n)throw new Error("消息"+t+"没有注册！");return n},e.encode=function(t,n){return new(e.getMessageModel(t))(n).encode().toBuffer()},e.decode=function(t,n){return e.getMessageModel(t).decode(n)},e.protoModels={},e}();egret.registerClass(ProtoBuild,"ProtoBuild");